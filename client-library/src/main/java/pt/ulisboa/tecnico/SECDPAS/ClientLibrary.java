package pt.ulisboa.tecnico.SECDPAS;

/* these are generated by the hello-world-server contract */
import SECDPAS.grpc.Contract;
import SECDPAS.grpc.DPASServiceGrpc;

import com.google.protobuf.Empty;

import com.google.protobuf.ByteString;
import io.grpc.ManagedChannel;
import io.grpc.ManagedChannelBuilder;
import org.apache.commons.lang3.SerializationUtils;

import java.security.PublicKey;

public class ClientLibrary {

	private String host = "localhost";
	private int port = 8080;
	private String target = host + ":" + port;

	private ManagedChannel channel;
	private DPASServiceGrpc.DPASServiceBlockingStub stub;

	public ClientLibrary(String host, int port){
		this.target = host + ":" + port;
		this.channel = ManagedChannelBuilder.forTarget(target).usePlaintext().build();
		this.stub = DPASServiceGrpc.newBlockingStub(channel);
	}

	public ClientLibrary(){
		super();
		this.channel = ManagedChannelBuilder.forTarget(target).usePlaintext().build();
		this.stub = DPASServiceGrpc.newBlockingStub(channel);
	}

	public void Register(PublicKey userKey) throws ClientAlreadyRegistredException{
		//Serializes key and changes to ByteString
		ByteString publicKey = ByteString.copyFrom(SerializationUtils.serialize(userKey));
		Contract.RegisterRequest request = Contract.RegisterRequest.newBuilder().setPublicKey(publicKey).build();
		try{
			Empty response = stub.register(request);
		} catch (RuntimeException e){
			throw new ClientAlreadyRegistredException(e.getMessage());
		}
	}

	public void Post(PublicKey userKey, char[] message, Announcement[] references) throws ClientPostTooLongException, ClientNotRegistredException{
		try{
			Empty response = stub.post(getPostRequest(userKey, message, references));
		} catch (ClientPostTooLongException e){
			throw e;
		} catch (RuntimeException e){
			throw new ClientNotRegistredException(e.getMessage());
		}
	}

	public void PostGeneral(PublicKey userKey, char[] message, Announcement[] references) throws ClientPostTooLongException, ClientNotRegistredException{
		try{
			Empty response = stub.postGeneral(getPostRequest(userKey, message, references));
		} catch (ClientPostTooLongException e){
			throw e;
		} catch (RuntimeException e){
			throw new ClientNotRegistredException(e.getMessage());
		}
	}

	public Announcement[] read(PublicKey userKey, int number) throws ClientNotRegistredException{
		ByteString publicKey = ByteString.copyFrom(SerializationUtils.serialize(userKey));
		Contract.ReadRequest request = Contract.ReadRequest.newBuilder().setPublicKey(publicKey).setNumber(number).build();

		try {
			Contract.ReadResponse response = stub.read(request);
			return SerializationUtils.deserialize(response.getAnnouncements().toByteArray());
		} catch (RuntimeException e){
			throw new ClientNotRegistredException(e.getMessage());
		}
	}

	public Announcement[] readGeneral(PublicKey userKey, int number) throws ClientNotRegistredException{
		ByteString publicKey = ByteString.copyFrom(SerializationUtils.serialize(userKey));
		Contract.ReadRequest request = Contract.ReadRequest.newBuilder().setPublicKey(publicKey).setNumber(number).build();

		try {
			Contract.ReadResponse response = stub.readGeneral(request);
			return SerializationUtils.deserialize(response.getAnnouncements().toByteArray());
		} catch (RuntimeException e){
			throw new ClientNotRegistredException(e.getMessage());
		}
	}

	/*************************/
	/**** AUX FUNCTIONS ******/
	/*************************/

	public Contract.PostRequest getPostRequest(PublicKey userKey, char[] message, Announcement[] references) throws ClientPostTooLongException{
		if(message.length > 256){
			throw  new ClientPostTooLongException("Post too long, must be smaller than 256 chars");
		}

		ByteString publicKey = ByteString.copyFrom(SerializationUtils.serialize(userKey));
		String post = message.toString();
		ByteString announcements = ByteString.copyFrom(SerializationUtils.serialize(references));

		return Contract.PostRequest.newBuilder().setPublicKey(publicKey).setMessage(post).setAnnouncements(announcements).build();
	}


}
